<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Gestor Financeiro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .scroll-hidden::-webkit-scrollbar {
            display: none;
        }
        .scroll-hidden {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* Cor primária para o tema */
        :root {
            --color-primary: #10B981; /* Verde Esmeralda */
            --color-primary-dark: #059669;
            --color-danger: #EF4444; /* Vermelho */
            --color-danger-dark: #DC2626;
        }
        .bg-primary { background-color: var(--color-primary); }
        .text-primary { color: var(--color-primary); }
        .border-primary { border-color: var(--color-primary); }
        .bg-primary-dark { background-color: var(--color-primary-dark); }
        .bg-danger { background-color: var(--color-danger); }
        .text-danger { color: var(--color-danger); }
        .bg-danger-dark { background-color: var(--color-danger-dark); }
        
        .modal-enter { animation: fadeIn 0.3s ease-out forwards; }
        .modal-leave { animation: fadeOut 0.3s ease-in forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(20px); }
        }
        .loader {
            border-top-color: var(--color-primary);
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }

        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Animação de Confete */
        #confetti-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; overflow: hidden; z-index: 1000;
        }
        .confetti {
            position: absolute; width: 10px; height: 10px;
            background-color: #f00; opacity: 0.7;
            animation: fall 4s linear forwards;
        }
        @keyframes fall {
            to { transform: translateY(100vh) rotate(360deg); opacity: 0; }
        }

        /* Animações da Tela de Login */
        .login-gradient-bg {
            background: linear-gradient(-45deg, #059669, #10B981, #34D399, #6EE7B7);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
        }
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .fade-in-up {
            animation: fadeInUp 0.8s ease-out forwards;
            opacity: 0;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .shake {
            animation: shake 0.5s ease-in-out;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Animação de Confete -->
    <div id="confetti-overlay"></div>

    <!-- Tela de Login -->
    <div id="login-screen" class="fixed inset-0 z-50 flex flex-col items-center justify-center p-4 login-gradient-bg transition-opacity duration-500">
        <div class="w-full max-w-sm text-center">
            <h1 class="text-4xl font-bold text-white mb-2 fade-in-up" style="animation-delay: 0.2s;">Meu Gestor</h1>
            <p class="text-white/80 mb-8 fade-in-up" style="animation-delay: 0.4s;">Suas finanças, seu controle.</p>
            
            <form id="login-form" class="space-y-4">
                <input type="text" id="username" placeholder="Nome de usuário" class="w-full p-4 rounded-lg border-none text-gray-700 fade-in-up" style="animation-delay: 0.6s;">
                <input type="password" id="password" placeholder="Senha" class="w-full p-4 rounded-lg border-none text-gray-700 fade-in-up" style="animation-delay: 0.8s;">
                <p id="login-error" class="text-white bg-red-500/80 p-2 rounded-lg hidden"></p>
                <button type="submit" class="w-full bg-white text-primary font-bold py-4 px-4 rounded-xl hover:bg-gray-200 transition-colors text-lg fade-in-up" style="animation-delay: 1s;">Entrar</button>
            </form>
        </div>
    </div>

    <!-- Tela de Carregamento -->
    <div id="loading-overlay" class="fixed inset-0 bg-white flex-col justify-center items-center z-40 transition-opacity duration-500 ease-in-out hidden">
        <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4"></div>
        <p class="text-lg font-semibold text-gray-600">Carregando suas finanças...</p>
    </div>

    <div id="app" class="max-w-md mx-auto bg-white shadow-lg h-screen flex-col opacity-0 transition-opacity duration-500 ease-in-out hidden">
        
        <!-- Cabeçalho Principal -->
        <header id="main-header" class="p-4 border-b flex justify-between items-center bg-white sticky top-0 z-20">
            <h1 id="user-greeting" class="text-xl font-bold text-gray-800">Olá, Usuário!</h1>
            <div class="flex items-center space-x-2">
                <button id="notification-btn" class="relative p-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"></path><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"></path></svg>
                    <span id="notification-badge" class="absolute top-0 right-0 block h-2.5 w-2.5 rounded-full bg-red-500 ring-2 ring-white hidden"></span>
                </button>
                <button id="logout-btn" title="Sair" class="p-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                </button>
            </div>
        </header>

        <!-- Painel de Notificações -->
        <div id="notification-panel" class="absolute top-16 right-4 w-80 bg-white rounded-lg shadow-xl border z-30 hidden transition-transform transform origin-top-right">
            <div class="p-3 border-b flex justify-between items-center">
                <h3 class="font-semibold text-gray-700">Notificações</h3>
                <button id="clear-notifications-btn" class="text-xs text-primary hover:underline">Limpar tudo</button>
            </div>
            <div id="notification-list" class="p-2 max-h-80 overflow-y-auto scroll-hidden">
                <!-- Notificações serão injetadas aqui -->
            </div>
        </div>
        
        <!-- Conteúdo Principal (Telas) -->
        <main class="flex-1 overflow-y-auto pb-20 scroll-hidden min-h-0">
            <!-- Tela: Dashboard -->
            <div id="dashboard-screen">
                <div class="p-4 space-y-6">
                    <!-- Navegador de Mês -->
                    <div class="flex justify-between items-center">
                        <button id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
                        </button>
                        <h2 id="current-month-display" class="text-xl font-bold text-gray-700"></h2>
                        <button id="next-month-btn" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                        </button>
                    </div>

                    <!-- Card Saldo -->
                    <div class="bg-primary text-white p-6 rounded-2xl shadow-lg">
                        <p class="text-sm opacity-80">Saldo do Mês</p>
                        <p id="dashboard-balance" class="text-4xl font-bold mt-1">R$ 0,00</p>
                    </div>

                    <!-- Cards Receitas e Despesas -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-gray-100 p-4 rounded-2xl">
                            <div class="flex items-center space-x-2">
                                <div class="bg-green-100 p-2 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-600"><line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></svg></div>
                                <p class="text-gray-500">Receitas</p>
                            </div>
                            <p id="dashboard-income" class="text-xl font-semibold mt-2">R$ 0,00</p>
                        </div>
                        <div class="bg-gray-100 p-4 rounded-2xl">
                           <div class="flex items-center space-x-2">
                               <div class="bg-red-100 p-2 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-500"><line x1="12" y1="5" x2="12" y2="19"></line><polyline points="19 12 12 19 5 12"></polyline></svg></div>
                                <p class="text-gray-500">Despesas</p>
                            </div>
                            <p id="dashboard-expense" class="text-xl font-semibold mt-2">R$ 0,00</p>
                        </div>
                    </div>
                    
                    
                    <!-- Metas -->
                    <div class="space-y-3">
                        <h3 class="text-lg font-semibold">Minhas Metas</h3>
                        <div id="dashboard-goals-list" class="space-y-3">
                           <!-- Metas serão injetadas aqui -->
                        </div>
                    </div>

                    <!-- Últimas Transações -->
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Transações do Mês</h3>
                        <div id="dashboard-transactions-list" class="space-y-3">
                           <!-- Transações serão injetadas aqui -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tela: Histórico -->
            <div id="history-screen" class="hidden p-4">
                 <h2 class="text-2xl font-bold mb-4">Histórico de Transações</h2>
                 <div class="mb-4">
                    <select id="month-filter" class="w-full p-2 border rounded-md bg-gray-100">
                        <!-- Opções de meses serão injetadas aqui -->
                    </select>
                 </div>
                 <div id="history-list" class="space-y-3">
                    <!-- Lista completa será injetada aqui -->
                 </div>
            </div>
            
             <!-- Tela: Metas -->
            <div id="goals-screen" class="hidden p-4">
                <h2 class="text-2xl font-bold mb-4">Gerenciar Metas</h2>
                 <form id="add-goal-form" class="bg-gray-100 p-4 rounded-2xl space-y-3 mb-6">
                    <h3 class="font-semibold text-lg">Nova Meta</h3>
                    <div>
                        <label for="goal-name" class="text-sm font-medium text-gray-600">Nome da Meta</label>
                        <input type="text" id="goal-name" class="mt-1 w-full p-2 border rounded-md" placeholder="Ex: Viagem de Férias" required>
                    </div>
                    <div>
                        <label for="goal-target" class="text-sm font-medium text-gray-600">Valor Alvo</label>
                        <input type="number" id="goal-target" step="0.01" class="mt-1 w-full p-2 border rounded-md" placeholder="5000.00" required>
                    </div>
                     <button type="submit" class="w-full bg-primary text-white font-bold py-3 px-4 rounded-xl hover:bg-primary-dark transition-colors">Adicionar Meta</button>
                </form>
                
                <div id="goals-list-full" class="space-y-4">
                    <!-- Lista de metas ativas será injetada aqui -->
                </div>

                <div id="completed-goals-container" class="mt-8">
                    <h3 class="text-lg font-semibold mb-4">Metas Concluídas</h3>
                    <div id="completed-goals-list" class="space-y-4">
                        <!-- Lista de metas concluídas será injetada aqui -->
                    </div>
                </div>
            </div>

            <!-- Tela: Calculadora -->
            <div id="calculator-screen" class="hidden p-4 space-y-6">
                <div class="bg-gray-100 p-4 rounded-2xl">
                    <h3 class="font-semibold text-lg mb-4">Divisor de Contas</h3>
                    <div class="space-y-4">
                        <div>
                            <label for="bill-total" class="text-sm font-medium text-gray-600">Total da Conta (R$)</label>
                            <input type="number" id="bill-total" step="0.01" class="mt-1 w-full p-3 border rounded-lg bg-white" placeholder="0,00">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="bill-tip" class="text-sm font-medium text-gray-600">Gorjeta (%)</label>
                                <input type="number" id="bill-tip" class="mt-1 w-full p-3 border rounded-lg bg-white" placeholder="10" value="10">
                            </div>
                            <div>
                                <label for="bill-people" class="text-sm font-medium text-gray-600">Nº de Pessoas</label>
                                <input type="number" id="bill-people" class="mt-1 w-full p-3 border rounded-lg bg-white" placeholder="1" value="1" min="1">
                            </div>
                        </div>
                        <div class="bg-primary/10 border-l-4 border-primary p-4 rounded-r-lg mt-4">
                            <p class="text-sm text-primary font-medium">Total por Pessoa</p>
                            <p id="bill-result" class="text-3xl font-bold text-primary mt-1">R$ 0,00</p>
                        </div>
                    </div>
                </div>
                <!-- Futuramente, outras calculadoras podem ser adicionadas aqui -->
            </div>
        </main>
        
        <!-- Navegação Inferior -->
        <nav class="w-full max-w-md fixed bottom-0 bg-white border-t z-20">
            <div class="flex justify-around items-center h-16">
                <button class="nav-btn p-2 text-primary flex flex-col items-center" data-screen="dashboard-screen">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                    <span class="text-xs mt-1">Início</span>
                </button>
                <button class="nav-btn p-2 text-gray-500 flex flex-col items-center" data-screen="history-screen">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"></path></svg>
                    <span class="text-xs mt-1">Histórico</span>
                </button>

                <button id="open-transaction-modal-btn" class="bg-primary text-white rounded-full p-3 shadow-lg hover:bg-primary-dark transition-transform hover:scale-105 -mt-8">
                     <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                </button>

                <button class="nav-btn p-2 text-gray-500 flex flex-col items-center" data-screen="goals-screen">
                   <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                    <span class="text-xs mt-1">Metas</span>
                </button>
                 <button class="nav-btn p-2 text-gray-500 flex flex-col items-center" data-screen="calculator-screen">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" y1="6" x2="16" y2="6"/><line x1="16" y1="14" x2="16" y2="18"/><line x1="8" y1="10" x2="8" y2="18"/><line x1="8" y1="14" x2="16" y2="14"/></svg>
                    <span class="text-xs mt-1">Calculadora</span>
                </button>
            </div>
        </nav>
    </div>

    <!-- Modal: Adicionar Transação -->
    <div id="transaction-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-40 hidden">
        <div id="transaction-modal-content" class="bg-white rounded-2xl w-full max-w-md max-h-[90vh] overflow-y-auto p-6 space-y-4 modal-enter">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold">Nova Transação</h2>
                <button id="close-transaction-modal-btn">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            
            <form id="add-transaction-form" class="space-y-4">
                <!-- Tipo: Receita ou Despesa -->
                <div class="grid grid-cols-2 gap-2 rounded-lg bg-gray-200 p-1">
                    <button type="button" id="type-btn-income" class="transaction-type-btn bg-white text-gray-800 py-2 rounded-md font-semibold">Receita</button>
                    <button type="button" id="type-btn-expense" class="transaction-type-btn bg-transparent text-gray-500 py-2 rounded-md font-semibold">Despesa</button>
                    <input type="hidden" id="transaction-type" value="income">
                </div>

                <div>
                    <label for="transaction-description" class="text-sm font-medium text-gray-600">Descrição</label>
                    <input type="text" id="transaction-description" class="mt-1 w-full p-3 border rounded-lg bg-gray-50" placeholder="Ex: Salário, Almoço" required>
                </div>

                <div>
                    <label for="transaction-amount" class="text-sm font-medium text-gray-600">Valor</label>
                    <input type="number" id="transaction-amount" step="0.01" class="mt-1 w-full p-3 border rounded-lg bg-gray-50" placeholder="0.00" required>
                </div>
                
                <div>
                    <label for="transaction-date" class="text-sm font-medium text-gray-600">Data</label>
                    <input type="date" id="transaction-date" class="mt-1 w-full p-3 border rounded-lg bg-gray-50" required>
                </div>
                
                <div>
                    <label for="transaction-category" class="text-sm font-medium text-gray-600">Categoria</label>
                    <select id="transaction-category" class="mt-1 w-full p-3 border rounded-lg bg-gray-50" required>
                        <!-- Opções de categoria são dinâmicas -->
                    </select>
                </div>
                
                <!-- Recorrência Mensal -->
                <div id="recurring-field" class="hidden flex items-center justify-between bg-gray-50 p-3 rounded-lg">
                    <label for="transaction-recurring" class="text-sm font-medium text-gray-600 select-none">Repetir esta entrada todo mês</label>
                    <input type="checkbox" id="transaction-recurring" class="h-5 w-5 rounded text-primary focus:ring-primary border-gray-300">
                </div>

                <div id="payment-method-container">
                    <label for="transaction-payment-method" class="text-sm font-medium text-gray-600">Método de Pagamento</label>
                    <select id="transaction-payment-method" class="mt-1 w-full p-3 border rounded-lg bg-gray-50" required>
                        <option value="Dinheiro">Dinheiro</option>
                        <option value="Débito">Débito</option>
                        <option value="Crédito">Cartão de Crédito</option>
                        <option value="PIX">PIX</option>
                    </select>
                </div>
                
                <!-- Campo de Parcelas (condicional) -->
                <div id="installments-field" class="hidden">
                    <label for="transaction-installments" class="text-sm font-medium text-gray-600">Número de Parcelas</label>
                    <input type="number" id="transaction-installments" class="mt-1 w-full p-3 border rounded-lg bg-gray-50" placeholder="1" min="1" value="1">
                </div>
                
                <button type="submit" class="w-full bg-primary text-white font-bold py-3 px-4 rounded-xl hover:bg-primary-dark transition-colors text-lg">Salvar Transação</button>
            </form>
        </div>
    </div>
    
    <!-- Modal: Adicionar Valor à Meta -->
    <div id="add-to-goal-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-40 hidden">
        <div id="add-to-goal-modal-content" class="bg-white rounded-2xl w-full max-w-md p-6 space-y-4 modal-enter">
            <h2 class="text-2xl font-bold">Adicionar à Meta</h2>
            <form id="add-to-goal-form" class="space-y-4">
                <input type="hidden" id="goal-id-input">
                <div>
                    <label for="add-to-goal-amount" class="text-sm font-medium text-gray-600">Valor a adicionar</label>
                    <input type="number" id="add-to-goal-amount" step="0.01" class="mt-1 w-full p-3 border rounded-lg bg-gray-50" placeholder="0.00" required>
                </div>
                <div class="flex gap-4">
                    <button type="button" id="cancel-add-to-goal-btn" class="w-full bg-gray-200 text-gray-800 font-bold py-3 px-4 rounded-xl hover:bg-gray-300 transition-colors">Cancelar</button>
                    <button type="submit" class="w-full bg-primary text-white font-bold py-3 px-4 rounded-xl hover:bg-primary-dark transition-colors">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Confirmação de Exclusão -->
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 space-y-4 modal-enter text-center">
            <h2 id="confirm-title" class="text-xl font-bold">Confirmar Exclusão</h2>
            <p id="confirm-message" class="text-gray-600">Você tem certeza que deseja excluir este item? Esta ação não pode ser desfeita.</p>
            <div class="flex gap-4 pt-2">
                <button id="confirm-cancel-btn" class="w-full bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-xl hover:bg-gray-300 transition-colors">Cancelar</button>
                <button id="confirm-ok-btn" class="w-full bg-danger text-white font-bold py-2 px-4 rounded-xl hover:bg-danger-dark transition-colors">Excluir</button>
            </div>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- ESTADO DA APLICAÇÃO (GLOBAL) ---
        let transactions, goals, recurringIncomes, notifications;
        let displayedDate = new Date();
        let editingTransactionId = null;
        let confirmCallback = null;
        let currentUserId = null;

        // --- MODELO DE DADOS E GESTÃO ---
        const getInitialData = () => {
            return {
                users: {
                    'ferreira': {
                        password: '981', name: 'Ferreira',
                        data: { transactions: [], goals: [], recurringIncomes: [], notifications: [] }
                    },
                    'livia': {
                        password: 'hoff', name: 'Livia',
                        data: { transactions: [], goals: [], recurringIncomes: [], notifications: [] }
                    }
                },
                currentUserId: null
            };
        };

        const loadAppData = () => {
            const data = localStorage.getItem('appData');
            return data ? JSON.parse(data) : getInitialData();
        };

        const saveAppData = (appData) => {
            localStorage.setItem('appData', JSON.stringify(appData));
        };

        const loadUserData = (appData, userId) => {
            const userData = appData.users[userId].data;
            transactions = userData.transactions || [];
            goals = userData.goals || [];
            recurringIncomes = userData.recurringIncomes || [];
            notifications = userData.notifications || [];
            currentUserId = userId;
        };

        const saveUserData = (appData) => {
            if (!currentUserId) return;
            appData.users[currentUserId].data = {
                transactions, goals, recurringIncomes, notifications
            };
            saveAppData(appData);
        };
        
        let appData = loadAppData();

        // --- SELETORES DE ELEMENTOS DOM ---
        const mainContent = document.querySelector('main');
        const screens = document.querySelectorAll('main > div');
        const navButtons = document.querySelectorAll('.nav-btn');
        const openModalBtn = document.getElementById('open-transaction-modal-btn');
        const closeModalBtn = document.getElementById('close-transaction-modal-btn');
        const transactionModal = document.getElementById('transaction-modal');
        const transactionModalContent = document.getElementById('transaction-modal-content');
        const transactionForm = document.getElementById('add-transaction-form');
        const installmentsField = document.getElementById('installments-field');
        const paymentMethodSelect = document.getElementById('transaction-payment-method');
        const transactionTypeInput = document.getElementById('transaction-type');
        const typeBtnIncome = document.getElementById('type-btn-income');
        const typeBtnExpense = document.getElementById('type-btn-expense');
        const categorySelect = document.getElementById('transaction-category');
        const recurringField = document.getElementById('recurring-field');
        const goalForm = document.getElementById('add-goal-form');
        const monthFilter = document.getElementById('month-filter');

        const prevMonthBtn = document.getElementById('prev-month-btn');
        const nextMonthBtn = document.getElementById('next-month-btn');
        const currentMonthDisplay = document.getElementById('current-month-display');
        
        const notificationBtn = document.getElementById('notification-btn');
        const notificationBadge = document.getElementById('notification-badge');
        const notificationPanel = document.getElementById('notification-panel');
        const clearNotificationsBtn = document.getElementById('clear-notifications-btn');

        const confirmModal = document.getElementById('confirm-modal');
        const confirmOkBtn = document.getElementById('confirm-ok-btn');
        const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
        const addToGoalModal = document.getElementById('add-to-goal-modal');
        const addToGoalForm = document.getElementById('add-to-goal-form');
        const cancelAddToGoalBtn = document.getElementById('cancel-add-to-goal-btn');
        const goalIdInput = document.getElementById('goal-id-input');
        
        const billTotalInput = document.getElementById('bill-total');
        const billTipInput = document.getElementById('bill-tip');
        const billPeopleInput = document.getElementById('bill-people');
        const billResultEl = document.getElementById('bill-result');

        const loginScreen = document.getElementById('login-screen');
        const loginForm = document.getElementById('login-form');
        const loadingOverlay = document.getElementById('loading-overlay');
        const appContainer = document.getElementById('app');
        const logoutBtn = document.getElementById('logout-btn');
        const userGreeting = document.getElementById('user-greeting');
        const loginError = document.getElementById('login-error');

        // --- LÓGICA DE NAVEGAÇÃO ---
        const switchScreen = (screenId) => {
            screens.forEach(screen => screen.classList.add('hidden'));
            document.getElementById(screenId).classList.remove('hidden');

            navButtons.forEach(btn => {
                if (btn.dataset.screen === screenId) {
                    btn.classList.remove('text-gray-500');
                    btn.classList.add('text-primary');
                } else {
                    btn.classList.remove('text-primary');
                    btn.classList.add('text-gray-500');
                }
            });
            const screenTitle = getScreenTitle(screenId);
            userGreeting.textContent = screenId === 'dashboard-screen' ? `Olá, ${appData.users[currentUserId].name}!` : screenTitle;
        };
        
        const getScreenTitle = (screenId) => {
            switch(screenId) {
                case 'dashboard-screen': return 'Resumo Mensal';
                case 'history-screen': return 'Histórico';
                case 'goals-screen': return 'Minhas Metas';
                case 'calculator-screen': return 'Calculadoras';
                default: return 'Meu Gestor';
            }
        };

        navButtons.forEach(button => {
            button.addEventListener('click', () => switchScreen(button.dataset.screen));
        });
        
        prevMonthBtn.addEventListener('click', () => {
            displayedDate.setMonth(displayedDate.getMonth() - 1);
            renderDashboard();
        });

        nextMonthBtn.addEventListener('click', () => {
            displayedDate.setMonth(displayedDate.getMonth() + 1);
            renderDashboard();
        });

        // --- LÓGICA DE NOTIFICAÇÕES ---
        const addNotification = (message, type = 'info') => {
            const newNotification = {
                id: Date.now(), message, type,
                date: new Date().toISOString(), read: false,
            };
            notifications.unshift(newNotification);
            if (notifications.length > 50) notifications.pop();
            saveUserData(appData);
            renderNotifications();
        };

        const renderNotifications = () => {
            const unreadCount = notifications.filter(n => !n.read).length;
            if (unreadCount > 0) {
                notificationBadge.classList.remove('hidden');
            } else {
                notificationBadge.classList.add('hidden');
            }

            const listEl = document.getElementById('notification-list');
            if (notifications.length === 0) {
                listEl.innerHTML = '<p class="text-center text-sm text-gray-500 p-4">Nenhuma notificação.</p>';
                return;
            }

            listEl.innerHTML = notifications.map(n => `
                <div class="p-2.5 border-b border-gray-100 ${!n.read ? 'bg-primary/5' : ''}">
                    <p class="text-sm text-gray-700">${n.message}</p>
                    <p class="text-xs text-gray-400 mt-1">${new Date(n.date).toLocaleString('pt-BR', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' })}</p>
                </div>
            `).join('');
        };
        
        notificationBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            notificationPanel.classList.toggle('hidden');
            if (!notificationPanel.classList.contains('hidden')) {
                notifications.forEach(n => n.read = true);
                saveUserData(appData);
                renderNotifications();
            }
        });

        clearNotificationsBtn.addEventListener('click', () => {
            notifications = [];
            saveUserData(appData);
            renderNotifications();
        });

        document.addEventListener('click', (e) => {
            if (!notificationPanel.contains(e.target) && !notificationBtn.contains(e.target)) {
                notificationPanel.classList.add('hidden');
            }
        });

        // --- LÓGICA DOS MODAIS ---
        const openModal = (modal) => {
            modal.classList.remove('hidden');
            modal.children[0].classList.remove('modal-leave');
            modal.children[0].classList.add('modal-enter');
        };

        const closeModal = (modal) => {
            modal.children[0].classList.remove('modal-enter');
            modal.children[0].classList.add('modal-leave');
            setTimeout(() => modal.classList.add('hidden'), 300);
        };
        
        const resetTransactionModal = () => {
            editingTransactionId = null;
            transactionForm.reset();
            transactionModal.querySelector('h2').textContent = 'Nova Transação';
            transactionForm.querySelector('button[type="submit"]').textContent = 'Salvar Transação';
            document.getElementById('transaction-date').valueAsDate = new Date();
            setupTypeButtons('income');
        };

        openModalBtn.addEventListener('click', () => {
            resetTransactionModal();
            openModal(transactionModal);
        });
        closeModalBtn.addEventListener('click', () => closeModal(transactionModal));
        transactionModal.addEventListener('click', (e) => {
            if(e.target === transactionModal) closeModal(transactionModal);
        });
        
        const showConfirmation = (onConfirm) => {
            openModal(confirmModal);
            confirmCallback = onConfirm;
        };
        confirmOkBtn.addEventListener('click', () => {
            if (confirmCallback) confirmCallback();
            closeModal(confirmModal);
        });
        confirmCancelBtn.addEventListener('click', () => closeModal(confirmModal));
        
        cancelAddToGoalBtn.addEventListener('click', () => closeModal(addToGoalModal));
        addToGoalModal.addEventListener('click', (e) => {
            if(e.target === addToGoalModal) closeModal(addToGoalModal);
        });

        // --- LÓGICA DE EVENTOS PRINCIPAIS (DELEGAÇÃO) ---
        mainContent.addEventListener('click', (e) => {
            const deleteTransactionBtn = e.target.closest('.delete-transaction-btn');
            const editTransactionBtn = e.target.closest('.edit-transaction-btn');
            const deleteGoalBtn = e.target.closest('.delete-goal-btn');
            const addToGoalBtn = e.target.closest('.add-to-goal-btn');
            const payBtn = e.target.closest('.pay-btn');

            if (deleteTransactionBtn) {
                const transactionId = Number(deleteTransactionBtn.dataset.id);
                showConfirmation(() => {
                    transactions = transactions.filter(t => t.id !== transactionId);
                    saveAndRender();
                });
            }

            if(editTransactionBtn) {
                const transactionId = Number(editTransactionBtn.dataset.id);
                openEditTransactionModal(transactionId);
            }

            if (payBtn) {
                const transactionId = Number(payBtn.dataset.id);
                const transaction = transactions.find(t => t.id === transactionId);
                if (transaction && transaction.status === 'pendente') {
                    transaction.status = 'pago';
                    saveAndRender();
                    addNotification(`Conta "${transaction.description}" foi marcada como paga.`);
                }
            }
            
            if (deleteGoalBtn) {
                const goalId = Number(deleteGoalBtn.dataset.id);
                showConfirmation(() => {
                    goals = goals.filter(g => g.id !== goalId);
                    saveAndRender();
                });
            }
            
            if (addToGoalBtn) {
                const goalId = Number(addToGoalBtn.dataset.id);
                goalIdInput.value = goalId;
                openModal(addToGoalModal);
            }
        });

        // --- LÓGICA DOS FORMULÁRIOS E MODAL DE EDIÇÃO ---
         const openEditTransactionModal = (transactionId) => {
            editingTransactionId = transactionId;
            const transaction = transactions.find(t => t.id === transactionId);
            if (!transaction) return;

            // Set form values
            setupTypeButtons(transaction.type);
            document.getElementById('transaction-description').value = transaction.description;
            document.getElementById('transaction-amount').value = transaction.amount;
            document.getElementById('transaction-date').value = transaction.date;
            categorySelect.value = transaction.category;

            if (transaction.type === 'expense') {
                paymentMethodSelect.value = transaction.paymentMethod;
            }

            // Update modal UI
            transactionModal.querySelector('h2').textContent = 'Editar Transação';
            transactionForm.querySelector('button[type="submit"]').textContent = 'Salvar Alterações';
            
            installmentsField.classList.add('hidden');
            recurringField.classList.add('hidden');

            openModal(transactionModal);
        };

        paymentMethodSelect.addEventListener('change', (e) => {
            const isExpense = transactionTypeInput.value === 'expense';
            if (e.target.value === 'Crédito' && isExpense) {
                installmentsField.classList.remove('hidden');
            } else {
                installmentsField.classList.add('hidden');
                document.getElementById('transaction-installments').value = 1;
            }
        });

        const allCategories = {
            income: ['Salário', 'Outras Receitas'],
            expense: ['Alimentação', 'Moradia', 'Transporte', 'Lazer', 'Saúde', 'Educação', 'Outras Despesas']
        };

        const updateCategoryOptions = (type) => {
            categorySelect.innerHTML = '';
            allCategories[type].forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                categorySelect.appendChild(option);
            });
        };

        const setupTypeButtons = (initialType = 'income') => {
            const paymentMethodContainer = document.getElementById('payment-method-container');
            const setActiveButton = (type) => {
                 updateCategoryOptions(type);
                 recurringField.classList.add('hidden');
                 document.getElementById('transaction-recurring').checked = false;

                 if (type === 'income') {
                    typeBtnIncome.classList.replace('bg-transparent', 'bg-white');
                    typeBtnIncome.classList.replace('text-gray-500', 'text-gray-800');
                    typeBtnExpense.classList.replace('bg-white', 'bg-transparent');
                    typeBtnExpense.classList.replace('text-gray-800', 'text-gray-500');
                    transactionTypeInput.value = 'income';
                    installmentsField.classList.add('hidden');
                    paymentMethodContainer.classList.add('hidden');
                    paymentMethodSelect.disabled = true;
                } else {
                    typeBtnExpense.classList.replace('bg-transparent', 'bg-white');
                    typeBtnExpense.classList.replace('text-gray-500', 'text-gray-800');
                    typeBtnIncome.classList.replace('bg-white', 'bg-transparent');
                    typeBtnIncome.classList.replace('text-gray-800', 'text-gray-500');
                    transactionTypeInput.value = 'expense';
                    paymentMethodContainer.classList.remove('hidden');
                    paymentMethodSelect.disabled = false;
                    paymentMethodSelect.dispatchEvent(new Event('change'));
                }
            };
            typeBtnIncome.addEventListener('click', () => setActiveButton('income'));
            typeBtnExpense.addEventListener('click', () => setActiveButton('expense'));
            
            categorySelect.addEventListener('change', (e) => {
                if(transactionTypeInput.value === 'income' && e.target.value === 'Salário') {
                    recurringField.classList.remove('hidden');
                } else {
                    recurringField.classList.add('hidden');
                }
            });
            
            setActiveButton(initialType);
        };

        transactionForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const description = document.getElementById('transaction-description').value;
            const amount = parseFloat(document.getElementById('transaction-amount').value);
            const dateStr = document.getElementById('transaction-date').value;
            const type = transactionTypeInput.value;
            const category = categorySelect.value;
            const paymentMethod = type === 'income' ? 'N/A' : paymentMethodSelect.value;

            if (editingTransactionId !== null) {
                const transaction = transactions.find(t => t.id === editingTransactionId);
                if(transaction) {
                    transaction.description = description;
                    transaction.amount = amount;
                    transaction.date = dateStr;
                    transaction.type = type;
                    transaction.category = category;
                    transaction.paymentMethod = paymentMethod;
                    // O status não é editado aqui, apenas com o botão "pagar"
                }
                addNotification(`Transação "${description}" foi atualizada.`);
            } else {
                const installments = parseInt(document.getElementById('transaction-installments').value) || 1;
                const isRecurring = document.getElementById('transaction-recurring').checked;

                if (isRecurring && type === 'income' && category === 'Salário') {
                    const dayOfMonth = new Date(dateStr + 'T12:00:00').getDate();
                    recurringIncomes.push({
                        id: Date.now(), description, amount, dayOfMonth, category,
                        lastAdded: null
                    });
                    addNotification(`Receita recorrente de salário (${formatCurrency(amount)}) foi configurada.`);
                }

                if (installments > 1 && type === 'expense' && paymentMethod === 'Crédito') {
                    const installmentAmount = amount / installments;
                    const originalDate = new Date(dateStr + 'T12:00:00'); 
                    for (let i = 0; i < installments; i++) {
                        const installmentDate = new Date(originalDate);
                        installmentDate.setMonth(installmentDate.getMonth() + i);
                        transactions.push({
                            id: Date.now() + i, description: `${description} (${i + 1}/${installments})`,
                            amount: installmentAmount, date: installmentDate.toISOString().split('T')[0],
                            type: 'expense', category, paymentMethod, status: 'pendente'
                        });
                    }
                    addNotification(`Compra parcelada de ${description} adicionada.`);
                } else {
                    transactions.push({
                        id: Date.now(), description, amount, date: dateStr, type, category, paymentMethod,
                        status: type === 'expense' ? 'pendente' : 'pago'
                    });
                    addNotification(`Nova ${type === 'income' ? 'receita' : 'despesa'}: ${formatCurrency(amount)}`);
                }
            }

            saveAndRender();
            closeModal(transactionModal);
        });
        
        goalForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('goal-name').value;
            const target = parseFloat(document.getElementById('goal-target').value);
            goals.push({ id: Date.now(), name, target, saved: 0, completed: false });
            goalForm.reset();
            addNotification(`Nova meta criada: "${name}"`);
            saveAndRender();
        });

        addToGoalForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const goalId = Number(goalIdInput.value);
            const amountToAdd = parseFloat(document.getElementById('add-to-goal-amount').value);
            const goal = goals.find(g => g.id === goalId);
            if (goal && amountToAdd > 0) {
                goal.saved += amountToAdd;
                addNotification(`Progresso na meta "${goal.name}": ${formatCurrency(amountToAdd)} adicionado!`);

                if (goal.saved >= goal.target && !goal.completed) {
                    goal.completed = true;
                    showConfettiAnimation();
                    addNotification(`Parabéns! Você alcançou sua meta "${goal.name}"!`);
                }

                saveAndRender();
            }
            addToGoalForm.reset();
            closeModal(addToGoalModal);
        });


        // --- LÓGICA DA CALCULADORA ---
        const calculateSplitBill = () => {
            const total = parseFloat(billTotalInput.value) || 0;
            const tipPercent = parseFloat(billTipInput.value) || 0;
            const people = parseInt(billPeopleInput.value);
            if (!people || people < 1) {
                billResultEl.textContent = formatCurrency(0);
                return;
            }
            const totalWithTip = total * (1 + tipPercent / 100);
            const amountPerPerson = totalWithTip / people;
            billResultEl.textContent = formatCurrency(amountPerPerson);
        };

        billTotalInput.addEventListener('input', calculateSplitBill);
        billTipInput.addEventListener('input', calculateSplitBill);
        billPeopleInput.addEventListener('input', calculateSplitBill);

        // --- LÓGICA DE RECORRÊNCIA E ALERTA ---
        const checkPendingBills = () => {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const threeDaysFromNow = new Date(today);
            threeDaysFromNow.setDate(today.getDate() + 3);

            transactions.forEach(t => {
                if (t.status === 'pendente') {
                    const dueDate = new Date(t.date + 'T12:00:00');
                    if (dueDate >= today && dueDate <= threeDaysFromNow) {
                        const notificationExists = notifications.some(n => n.message.includes(t.description) && n.message.includes('vence'));
                        if (!notificationExists) {
                            const daysUntilDue = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                            let message = '';
                            if (daysUntilDue <= 0) {
                                message = `Lembrete: A conta "${t.description}" vence hoje!`;
                            } else {
                                message = `Atenção: A conta "${t.description}" vence em ${daysUntilDue} dia(s).`;
                            }
                            addNotification(message, 'warning');
                        }
                    }
                }
            });
        };

        const processRecurringTransactions = () => {
            const now = new Date();
            const currentYearMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            const currentDay = now.getDate();
            let hasChanges = false;

            recurringIncomes.forEach(recurring => {
                if (recurring.lastAdded !== currentYearMonth && currentDay >= recurring.dayOfMonth) {
                    const transactionDate = new Date(now.getFullYear(), now.getMonth(), recurring.dayOfMonth);
                    transactions.push({
                        id: Date.now() + Math.random(),
                        description: recurring.description,
                        amount: recurring.amount,
                        date: transactionDate.toISOString().split('T')[0],
                        type: 'income', category: recurring.category,
                        paymentMethod: 'Transferência', status: 'pago'
                    });
                    recurring.lastAdded = currentYearMonth;
                    hasChanges = true;
                    addNotification(`Salário (${formatCurrency(recurring.amount)}) adicionado automaticamente.`);
                }
            });

            if (hasChanges) {
                saveAndRender();
            }
        };


        // --- LÓGICA DE RENDERIZAÇÃO ---
        const formatCurrency = (value) => {
            if (isNaN(value)) return "R$ 0,00";
            return `R$ ${value.toFixed(2).replace('.', ',')}`;
        }
        const formatDate = (dateStr) => {
            const [year, month, day] = dateStr.split('-');
            return `${day}/${month}/${year}`;
        }
        
        const renderDashboard = () => {
            const currentMonth = displayedDate.getMonth();
            const currentYear = displayedDate.getFullYear();

            const monthName = displayedDate.toLocaleString('pt-BR', { month: 'long', year: 'numeric' });
            currentMonthDisplay.textContent = monthName.charAt(0).toUpperCase() + monthName.slice(1);
            
            const monthTransactions = transactions.filter(t => {
                const tDate = new Date(t.date + 'T12:00:00');
                return tDate.getMonth() === currentMonth && tDate.getFullYear() === currentYear;
            });
            
            const income = monthTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expense = monthTransactions.filter(t => t.type === 'expense' && t.status === 'pago').reduce((sum, t) => sum + t.amount, 0);
            
            document.getElementById('dashboard-balance').textContent = formatCurrency(income - expense);
            document.getElementById('dashboard-income').textContent = formatCurrency(income);
            document.getElementById('dashboard-expense').textContent = formatCurrency(expense);

            const monthLatestTransactions = monthTransactions.sort((a,b) => new Date(b.date) - new Date(a.date));
            renderTransactionList(monthLatestTransactions, document.getElementById('dashboard-transactions-list'), true, false);

            const activeGoals = goals.filter(g => !g.completed);
            renderGoals(activeGoals, document.getElementById('dashboard-goals-list'), 2);
        };
        
        const renderTransactionList = (transactionList, element, showDate = true, showDeleteButton = true) => {
            element.innerHTML = transactionList.length ? '' : '<p class="text-gray-500 text-center">Nenhuma transação neste mês.</p>';
            transactionList.forEach(t => {
                const isIncome = t.type === 'income';
                const colorClass = isIncome ? 'text-green-600' : 'text-red-500';
                const sign = isIncome ? '+' : '-';
                const isPending = t.status === 'pendente';

                const statusIndicator = isIncome ? '' : `
                    <div title="${isPending ? 'Pendente' : 'Pago'}" class="p-1 rounded-full">
                        <div class="w-3 h-3 rounded-full ${isPending ? 'bg-yellow-500' : 'bg-green-500'}"></div>
                    </div>
                `;

                let actionControls = '';
                if(isPending) {
                    actionControls = `
                        <button data-id="${t.id}" class="pay-btn text-xs bg-primary text-white font-semibold py-1 px-3 rounded-full hover:bg-primary-dark transition-colors">
                            Pagar
                        </button>
                    `;
                }
                
                const editButtonHtml = `
                    <button data-id="${t.id}" class="edit-transaction-btn text-gray-400 hover:text-primary p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                    </button>
                `;
                
                const deleteButtonHtml = showDeleteButton ? `
                    <button data-id="${t.id}" class="delete-transaction-btn text-gray-400 hover:text-danger p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                    </button>
                ` : '';
                
                element.innerHTML += `
                    <div class="flex items-center justify-between bg-gray-50 p-3 rounded-lg group">
                        <div class="flex items-center space-x-3">
                            ${statusIndicator}
                            <div class="p-2 rounded-full bg-gray-200">${getCategoryIcon(t.category)}</div>
                            <div>
                                <p class="font-medium">${t.description}</p>
                                <p class="text-sm text-gray-500">${t.category}${showDate ? ' - ' + formatDate(t.date) : ''}</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                             <p class="font-semibold ${colorClass} mr-2">${sign} ${formatCurrency(t.amount)}</p>
                             ${actionControls}
                             <div class="flex items-center">
                                ${editButtonHtml}
                                ${deleteButtonHtml}
                             </div>
                        </div>
                    </div>
                `;
            });
        };
        
        const renderGoals = (goalsList, element, limit = null) => {
            const listToRender = limit ? goalsList.slice(0, limit) : goalsList;
            element.innerHTML = listToRender.length ? '' : '<p class="text-gray-500 text-center">Nenhuma meta por aqui.</p>';
            listToRender.forEach(g => {
                const progress = Math.min((g.saved / g.target) * 100, 100);
                element.innerHTML += `
                    <div class="bg-gray-100 p-4 rounded-lg">
                        <div class="flex justify-between items-center mb-1">
                            <p class="font-semibold">${g.name}</p>
                            <div class="flex items-center space-x-2">
                                <button data-id="${g.id}" class="add-to-goal-btn text-primary hover:text-primary-dark p-1 rounded-full">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14m-7-7h14" /></svg>
                                </button>
                                <button data-id="${g.id}" class="delete-goal-btn text-gray-400 hover:text-danger p-1 rounded-full">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                </button>
                            </div>
                        </div>
                        <div class="text-xs text-gray-500 mb-2">
                           ${formatCurrency(g.saved)} / ${formatCurrency(g.target)}
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div class="bg-primary h-2.5 rounded-full" style="width: ${progress}%"></div>
                        </div>
                    </div>
                `;
            });
        };

        const renderCompletedGoals = (goalsList, element) => {
             element.innerHTML = goalsList.length ? '' : '<p class="text-gray-500 text-center">Nenhuma meta concluída ainda.</p>';
             goalsList.forEach(g => {
                element.innerHTML += `
                    <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded-r-lg flex items-center justify-between group">
                        <div>
                             <p class="font-semibold text-green-800">${g.name}</p>
                             <p class="text-sm text-green-700 mt-1">Concluída! (${formatCurrency(g.target)})</p>
                        </div>
                        <div class="flex items-center">
                             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="text-green-500"><polyline points="20 6 9 17 4 12"></polyline></svg>
                             <button data-id="${g.id}" class="delete-goal-btn text-gray-400 hover:text-danger p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity ml-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                             </button>
                        </div>
                    </div>
                `;
             });
        }

        const renderHistory = () => {
             const selectedMonth = monthFilter.value;
             if (!selectedMonth) return;
             
             const filtered = transactions.filter(t => t.date.startsWith(selectedMonth));
             const sorted = filtered.sort((a,b) => new Date(b.date) - new Date(a.date));
             renderTransactionList(sorted, document.getElementById('history-list'), true, true);
        };

        const setupMonthFilter = () => {
            const months = new Set(transactions.map(t => t.date.substring(0, 7)));
            const sortedMonths = [...months].sort().reverse();
            
            const currentSelection = monthFilter.value;
            monthFilter.innerHTML = '';

            if (sortedMonths.length === 0) {
                 const now = new Date();
                 const currentMonthStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                 sortedMonths.push(currentMonthStr);
            }

            sortedMonths.forEach(month => {
                const [year, monthNum] = month.split('-');
                const monthName = new Date(year, monthNum - 1).toLocaleString('pt-BR', { month: 'long', year: 'numeric' });
                const option = document.createElement('option');
                option.value = month;
                option.textContent = monthName.charAt(0).toUpperCase() + monthName.slice(1);
                monthFilter.appendChild(option);
            });

            if (currentSelection && sortedMonths.includes(currentSelection)) {
                monthFilter.value = currentSelection;
            }

            monthFilter.removeEventListener('change', renderHistory);
            monthFilter.addEventListener('change', renderHistory);
        };
        
        const getCategoryIcon = (category) => {
            const icons = {
                'Salário': '💼', 'Alimentação': '🍔', 'Moradia': '🏠', 'Transporte': '🚗',
                'Lazer': '🎬', 'Saúde': '❤️', 'Educação': '📚', 'Outras Receitas': '💰', 'Outras Despesas': '🛒'
            };
            return icons[category] || '💸';
        };

        // --- FUNÇÕES DE CONTROLE ---
        const saveAndRender = () => {
            saveUserData(appData);
            renderAll();
        };
        
        const renderAll = () => {
            renderDashboard();
            setupMonthFilter();
            renderHistory();
            const activeGoals = goals.filter(g => !g.completed);
            const completedGoals = goals.filter(g => g.completed);
            renderGoals(activeGoals, document.getElementById('goals-list-full'));
            renderCompletedGoals(completedGoals, document.getElementById('completed-goals-list'));
        };

        // --- ANIMAÇÃO ---
        const showConfettiAnimation = () => {
            const confettiContainer = document.getElementById('confetti-overlay');
            for (let i = 0; i < 100; i++) {
                const confetti = document.createElement('div');
                confetti.classList.add('confetti');
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.animationDelay = Math.random() * 2 + 's';
                confetti.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
                confettiContainer.appendChild(confetti);
            }
            setTimeout(() => {
                confettiContainer.innerHTML = '';
            }, 4000);
        };


        // --- INICIALIZAÇÃO E AUTENTICAÇÃO ---
        const initApp = (userId) => {
            loadUserData(appData, userId);
            processRecurringTransactions();
            checkPendingBills();
            setupTypeButtons();
            switchScreen('dashboard-screen');
            renderAll();
            renderNotifications();
            calculateSplitBill();

            loadingOverlay.classList.add('opacity-0');
            setTimeout(() => {
                loadingOverlay.classList.add('hidden');
                loadingOverlay.classList.remove('flex');

                appContainer.classList.remove('hidden');
                appContainer.classList.add('flex');
                setTimeout(() => appContainer.classList.remove('opacity-0'), 50);
            }, 500);
        };
        
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value.toLowerCase();
            const password = document.getElementById('password').value;
            const user = appData.users[username];

            if (user && user.password === password) {
                appData.currentUserId = username;
                saveAppData(appData);

                loginScreen.classList.add('opacity-0');
                setTimeout(() => {
                    loginScreen.classList.add('hidden');
                    loadingOverlay.classList.remove('hidden');
                    loadingOverlay.classList.add('flex');
                    initApp(username);
                }, 500);
            } else {
                loginError.textContent = 'Usuário ou senha inválidos.';
                loginError.classList.remove('hidden');
                loginForm.classList.add('shake');
                setTimeout(() => loginForm.classList.remove('shake'), 500);
            }
        });

        logoutBtn.addEventListener('click', () => {
            appData.currentUserId = null;
            saveAppData(appData);
            location.reload();
        });

        // Verifica se há um usuário logado ao carregar a página
        if (appData.currentUserId && appData.users[appData.currentUserId]) {
            loginScreen.classList.add('hidden');
            loadingOverlay.classList.remove('hidden');
            loadingOverlay.classList.add('flex');
            initApp(appData.currentUserId);
        } else {
            loginScreen.classList.remove('hidden');
        }

    });
    </script>
</body>
</html>



